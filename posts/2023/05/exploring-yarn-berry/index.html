<!doctype html><html lang=ko><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>얀 베리 탐험하기 | PrayinForRain.dev</title>
<meta property="og:title" content="얀 베리 탐험하기 | PrayinForRain.dev"><meta name=twitter:title content="얀 베리 탐험하기 | PrayinForRain.dev"><meta itemprop=name content="얀 베리 탐험하기 | PrayinForRain.dev"><meta name=application-name content="얀 베리 탐험하기 | PrayinForRain.dev"><meta property="og:site_name" content="PrayinforRain.dev"><meta name=description content="Dev blog of PrayinForRain, a KR frontend engineer"><meta itemprop=description content="Dev blog of PrayinForRain, a KR frontend engineer"><meta property="og:description" content="Dev blog of PrayinForRain, a KR frontend engineer"><meta name=twitter:description content="Dev blog of PrayinForRain, a KR frontend engineer"><meta property="og:locale" content="ko"><meta name=language content="ko"><link rel=alternate hreflang=ko href=https://prayinforrain.github.io/posts/2023/05/exploring-yarn-berry/ title><meta itemprop=image content="https://prayinforrain.github.io/avatar.png"><meta property="og:image" content="https://prayinforrain.github.io/avatar.png"><meta name=twitter:image content="https://prayinforrain.github.io/avatar.png"><meta name=twitter:image:src content="https://prayinforrain.github.io/avatar.png"><meta property="og:type" content="article"><meta property="og:article:published_time" content=2023-05-30T02:27:49+0900><meta property="article:published_time" content=2023-05-30T02:27:49+0900><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"얀 베리 탐험하기","author":{"@type":"Person","name":""},"datePublished":"2023-05-30","description":"","wordCount":1830,"mainEntityOfPage":"True","dateModified":"2023-05-30","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"PrayinForRain.dev"}}</script><meta name=generator content="Hugo 0.135.0"><link rel=canonical href=https://prayinforrain.github.io/posts/2023/05/exploring-yarn-berry/><link href=/style.min.b986244e2fb36964e8f831c45e69cf0e3e208d4d9bf6b5eaf4caddc81dc0ba31.css rel=stylesheet><link href=/code-highlight.min.731e9fc351d3c45d032fb5f574575c296f67e08c1c6229b5ccbfd7bfb18217c5.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://prayinforrain.github.io/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-63GYNX3VF5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-63GYNX3VF5")}</script><script type=text/javascript src=//wcs.naver.net/wcslog.js></script><script type=text/javascript>if(!wcs_add)var wcs_add={};wcs_add.wa="1940c9395811670",window.wcs&&location.host==="prayinforrain.github.io"&&wcs_do()</script></head><body data-theme=auto class=notransition><script src=/js/theme.min.d17e61995c7d9fee9a7b0e77c95447101fe27fa434c458fab370732da48b2b17.js integrity="sha256-0X5hmVx9n+6aew53yVRHEB/if6Q0xFj6s3BzLaSLKxc="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://prayinforrain.github.io/ class=logo><svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=/tags/>Tags</a></li><li><a class=menu-link href=/about/>About</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>얀 베리 탐험하기</h1><div class=post-meta><time datetime=2023-05-30T02:27:49+09:00 itemprop=datePublished>2023. 5. 30.</time></div></header><details class=toc><summary><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#내-레포의-위험한-녀석>내 레포의 위험한 녀석</a></li><li><a href=#우리가-아는-node_modules>우리가 아는 node_modules</a><ul><li><a href=#패키지를-찾아서-헤매기>패키지를 찾아서 헤매기</a></li><li><a href=#유령-의존성>유령 의존성</a></li></ul></li><li><a href=#yarn-berry>Yarn berry</a><ul><li><a href=#작동-방식>작동 방식</a></li><li><a href=#유령-의존성-금지>유령 의존성 금지</a></li><li><a href=#peer-dependency-문제>Peer dependency 문제</a></li></ul></li><li><a href=#부록>부록</a><ul><li><a href=#부록1---yarn-dlx와-pnpify>부록1 - yarn dlx와 pnpify</a></li><li><a href=#부록2---사실-모든-것이-pnp의-잘못은-아닙니다>부록2 - 사실 모든 것이 PnP의 잘못은 아닙니다</a></li></ul></li><li><a href=#마치며>마치며..</a></li><li><a href=#refs>Refs.</a></li></ul></nav></details><div class=page-content><h2 id=내-레포의-위험한-녀석>내 레포의 위험한 녀석</h2><p><img src=/images/posts/2023/05/exploring-yarn-berry/01.png alt="cds issue"></p><p>최근 <a href=https://github.com/c-h-w-h/cds>차가운 디자인 시스템(CDS)</a>의 패키지 매니저를 <strong>Yarn berry</strong>로 마이그레이션 하는 작업을 하고 있다. 이유는 후술할 <code>node_modules</code> 자체의 단점도 있고, 내 데스크탑이 HDD를 사용하기 때문에 <code>node_modules</code>의 수십만 개의 파일들을 다루는 것이 너무 느려서 강력 추천했다.</p><p>하지만 사실 나는 PnP가 어떻게 패키지들을 resolve하는지 전혀 모른다. 그저 어떻게 해야 오류 없이 쓸 수 있는지만 열심히 고민했는데, 팀원들에게 설명할 때 마다 막연히 얀베리가 잘못했겠죠~ 하는 스스로에게 자괴감을 느껴 이 기회에 한 번 Yarn PnP를 똑바로 마주해 보기로 했다.</p><h2 id=우리가-아는-node_modules>우리가 아는 node_modules</h2><h3 id=패키지를-찾아서-헤매기>패키지를 찾아서 헤매기</h3><p>Node.js에는 사실 패키지의 개념이 명시적으로 정의되어 있지 않았다. 따라서 다른 모듈을 사용할 때에 Node.js는 패키지가 아닌 파일 단위로 모듈을 찾아서 resolve하고 있었다.</p><p>기존 npm의 경우에는 패키지의 node_modules, npm이 설치된 디렉토리의 전역 폴더 등등 여러 곳을 차례로 패키지를 찾아 나갔다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node
</span></span><span class=line><span class=cl>&gt; require.resolve.paths<span class=o>(</span><span class=s1>&#39;react-dom&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;E:\\workspace\\repl\\node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;E:\\workspace\\node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;E:\\workspace\\node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;E:\\node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Users\\dldnw\\.node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Users\\dldnw\\.node_libraries&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Program Files\\nodejs\\lib\\node&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Users\\dldnw\\.node_modules&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Users\\dldnw\\.node_libraries&#39;</span>,
</span></span><span class=line><span class=cl>  <span class=s1>&#39;C:\\Program Files\\nodejs\\lib\\node&#39;</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>&gt; require.resolve<span class=o>(</span><span class=s1>&#39;react-dom&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;E:\\workspace\\node_modules\\react-dom\\index.js&#39;</span>
</span></span></code></pre></div><p>이는 비효율적이다. <code>node_modules</code> 디렉토리는 가벼운 프로젝트에서도 만 개 단위의 파일들이 있어 탐색 속도가 느리고, <code>node_modules</code> 디렉토리 말고도 레포지토리의 상위 경로 등 탐색 범위가 매우 넓기 때문에 환경 의존적인 프로젝트가 될 수도 있다. 특히 이 과정은 런타임에서도 수시로 진행되어 매우 큰 성능 문제를 야기한다.</p><h3 id=유령-의존성>유령 의존성</h3><p>효율이야 어떻게 됐든 이런 식으로 패키지를 resolve한다고 치자. 그런데 문제가 또 있다.</p><p><img src=/images/posts/2023/05/exploring-yarn-berry/02.png alt="dependency hoisting"></p><p><em>출처: <a href=https://toss.tech/article/node-modules-and-yarn-berry>node_modules로부터 우리를 구원해 줄 Yarn Berry - 토스 기술블로그</a></em></p><p>위 사진에서 package-1은 A, C, D 패키지를 사용한다. 이 중 A와 C는 B(1.0)를 직, 간접적으로 의존하고 있기 때문에 결과적으로 B(1.0) 패키지도 필요한 상황이고, 결과적으로는 중복 파일을 줄여 용량을 절약하기 위해 B(1.0)을 호이스팅하여 <code>node_modules</code>에는 package-1이 요구하지 않은 B(1.0)이 추가로 설치된다.</p><p>이 후 Node는 package.json을 <strong>체크하지 않고</strong> node_modules 디렉토리에 있는 파일들을 기준으로 모듈을 resolve한다. 이렇게 되면 쥐도새도 모르게 package-1에서는 요구하지 않았던 B(1.0)의 모듈을 슬쩍 사용할 수 있게 된다. 분명 문제가 있다.</p><h2 id=yarn-berry>Yarn berry</h2><p>Yarn berry에서 나온 PnP 방식은 이런 문제들을 해결한다. <strong>Yarn PnP</strong>는 <code>package.json</code>을 기반으로 명시적인 의존성 트리를 생성하고, 모듈을 resolve하는 과정을 이 트리를 기반으로 처리하여 유령 의존성 문제를 해결하면서, 각각의 패키지를 하나의 <code>.zip</code> 압축 파일로 저장하기 때문에 파일 개수와 용량 측면에서 획기적인 절약을 이루어낸다.</p><h3 id=작동-방식>작동 방식</h3><p>yarn pnp가 생성하는 <code>.pnp.cjs</code> 파일에는 <code>readFileSync</code>같은 fs 모듈의 메서드가 구현되어 있고, 이 메서드들은 <code>.yarn/cache</code> 디렉토리의 zip 파일들을 참조할 수 있도록 연결한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>class</span> <span class=nx>NodeFS</span> <span class=kr>extends</span> <span class=nx>BasePortableFakeFS</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>readFileSync</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>encoding</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fsNativePath</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>p</span> <span class=o>===</span> <span class=sb>`string`</span> <span class=o>?</span> <span class=nx>npath</span><span class=p>.</span><span class=nx>fromPortablePath</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span> <span class=o>:</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>realFs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>fsNativePath</span><span class=p>,</span> <span class=nx>encoding</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>patchFs 메소드를 통해 기존 fs 모듈을 사용하는 코드들을 가로챈다. 이를 통해 .zip 파일 내부를 실제 디렉토리처럼 읽어올 수 있다.</p><aside><p>💡 <strong>아래 내용은 명확하게 정리되어 있지 않습니다!</strong><br>이게 뭔지 좀 더 깔끔하게 다듬을 필요가 있어 보여요. 읽는 분들 화이팅~</p></aside><p>이제 <code>pnpApi</code>를 사용해서 <code>react-dom</code> 패키지를 resolve하는 과정을 따라가보자. resolve되는 과정은 <a href=https://github.com/nodejs/node/blob/main/lib/internal/modules/cjs/loader.js#L889>Nodejs 레포지토리의 Module._load</a>과 <a href=https://nodejs.org/api/esm.html#resolver-algorithm-specification>Node.js 명세</a>를 참고해서, 패키지명을 가지고 모듈을 찾는 부분만 구현하는 것으로 한다. pnpApi의 명세는 <a href=https://yarnpkg.com/advanced/pnpapi>yarn의 PnP API 페이지</a>에 나와 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yarn node
</span></span><span class=line><span class=cl>&gt; <span class=nb>let</span> <span class=nv>p</span> <span class=o>=</span> require<span class=o>(</span><span class=s1>&#39;pnpapi&#39;</span><span class=o>)</span>
</span></span></code></pre></div><p>우선, 터미널에서 <code>yarn node</code> 를 실행해서 <code>.pnp.cjs</code> 패치가 적용된 node 터미널을 연다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; p.getAllLocators<span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span> name: <span class=s1>&#39;berry&#39;</span>, reference: <span class=s1>&#39;workspace:.&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span> name: <span class=s1>&#39;js-tokens&#39;</span>, reference: <span class=s1>&#39;npm:4.0.0&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span> name: <span class=s1>&#39;loose-envify&#39;</span>, reference: <span class=s1>&#39;npm:1.4.0&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span> name: <span class=s1>&#39;react-dom&#39;</span>, reference: <span class=s1>&#39;npm:18.2.0&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    name: <span class=s1>&#39;react-dom&#39;</span>,
</span></span><span class=line><span class=cl>    reference: <span class=s1>&#39;virtual:34069774f764f6c076c76cefb79f9c00ee35c2ecc2faeec6f1f046eac9e499da19f7441a38c80f3dc82287abf91ba64b7783b2e2d997751e40d1ad563ff4f78d#npm:18.2.0&#39;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=o>{</span> name: <span class=s1>&#39;scheduler&#39;</span>, reference: <span class=s1>&#39;npm:0.23.0&#39;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; p.getPackageInformation<span class=o>(</span>p.getAllLocators<span class=o>()[</span>3<span class=o>])</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  packageDependencies: Map<span class=o>(</span>1<span class=o>)</span> <span class=o>{</span> <span class=s1>&#39;react-dom&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;npm:18.2.0&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>  packagePeers: Set<span class=o>(</span>0<span class=o>)</span> <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  linkType: <span class=s1>&#39;SOFT&#39;</span>,
</span></span><span class=line><span class=cl>  discardFromLookup: false,
</span></span><span class=line><span class=cl>  packageLocation: <span class=s1>&#39;E:\\workspace\\.yarn\\cache\\react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip\\node_modules\\react-dom\\&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>getAllLocators</code>는 PnP 환경에 설치된 패키지들의 목록을 보여준다. 보면 프로젝트에 직접 의존성으로 명시된 <code>react-dom</code>만이 가상 경로를 갖는 것처럼 적혀 있다. 그리고 받은 Locator를 <code>getPackageInformation</code>에 인자로 사용해서 패키지의 정보를 확인할 수 있다. <code>packageLocation</code> 프로퍼티를 통해 패키지가 위치한 실제 경로를 다룬다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; fs.readFileSync<span class=o>(</span>p.getPackageInformation<span class=o>(</span>p.getAllLocators<span class=o>()[</span>3<span class=o>])</span>.packageLocation + <span class=s1>&#39;index.js&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>&lt;Buffer <span class=m>27</span> <span class=m>75</span> <span class=m>73</span> <span class=m>65</span> <span class=m>20</span> <span class=m>73</span> <span class=m>74</span> <span class=m>72</span> <span class=m>69</span> <span class=m>63</span> <span class=m>74</span> <span class=m>27</span> 3b 0a 0a <span class=m>66</span> <span class=m>75</span> 6e <span class=m>63</span> <span class=m>74</span> <span class=m>69</span> 6f 6e <span class=m>20</span> <span class=m>63</span> <span class=m>68</span> <span class=m>65</span> <span class=m>63</span> 6b <span class=m>44</span> <span class=m>43</span> <span class=m>45</span> <span class=m>28</span> <span class=m>29</span> <span class=m>20</span> 7b 0a <span class=m>20</span> <span class=m>20</span> 2f 2a <span class=m>20</span> <span class=m>67</span> 6c 6f <span class=m>62</span> <span class=m>61</span> 6c <span class=m>20</span> 5f ... <span class=m>1313</span> more bytes&gt;
</span></span></code></pre></div><p>그 이후 <code>.pnp.cjs</code>를 통해 재정의된 <code>fs.readFileSync</code>를 통해 디렉토리 내의 <code>index.js</code> 파일을 읽어올 수 있었다.</p><p>최종적으로 <code>react-dom</code>을 resolve하려면 이와 비슷한 과정을 통해 아래와 같은 경로로 연결되는 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ yarn node
</span></span><span class=line><span class=cl>&gt; require.resolve<span class=o>(</span><span class=s1>&#39;react-dom&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;E:\\workspace\\.yarn\\__virtual__\\react-dom-virtual-67ee33d872\\0\\cache\\react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip\\node_modules\\react-dom\\index.js&#39;</span>
</span></span></code></pre></div><h3 id=유령-의존성-금지>유령 의존성 금지</h3><p>반면에, 프로젝트 의존성에는 명시되지 않았으면서 <code>react-dom</code>이 의존하는 패키지가 있다. <code>loose-envify</code>와 <code>scheduler</code> 두 개가 있는데, 실제로도 <code>react-dom</code>을 설치할 경우 <code>.yarn/cache</code> 디렉토리에 두 패키지가 함께 설치되는 것을 볼 수 있다. npm의 <code>node_modules</code>도 마찬가지다.</p><p>그런데 이들은 <code>require.resolve()</code>를 통해서 찾을 수 없는데, 이는 <code>.pnp.cjs</code>상에서 <strong>패키지의 가상 경로가 존재하지 않기 때문</strong>이다. 참고로 <code>.pnp.cjs</code>의 내용은 아래처럼 생겼다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// .pnp.cjs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>$$SETUP_STATE</span><span class=p>(</span><span class=nx>hydrateRuntimeState</span><span class=p>,</span> <span class=nx>basePath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>hydrateRuntimeState</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=err>&#39;</span><span class=p>{</span><span class=o>\</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>[</span><span class=s2>&#34;react-dom&#34;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;npm:18.2.0&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageLocation&#34;</span><span class=o>:</span> <span class=s2>&#34;./.yarn/cache/react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip/node_modules/react-dom/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageDependencies&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;react-dom&#34;</span><span class=p>,</span> <span class=s2>&#34;npm:18.2.0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;linkType&#34;</span><span class=o>:</span> <span class=s2>&#34;SOFT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;virtual:34069774f764f6c076c76cefb79f9c00ee35c2ecc2faeec6f1f046eac9e499da19f7441a38c80f3dc82287abf91ba64b7783b2e2d997751e40d1ad563ff4f78d#npm:18.2.0&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageLocation&#34;</span><span class=o>:</span> <span class=s2>&#34;./.yarn/__virtual__/react-dom-virtual-67ee33d872/0/cache/react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip/node_modules/react-dom/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span></code></pre></div><p>우선 비교를 위해 <code>react-dom</code>이 설치된 npm 프로젝트에서 다음 코드를 작성한다고 하자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=o>*</span> <span class=nx>as</span> <span class=nx>envify</span> <span class=nx>from</span> <span class=s2>&#34;loose-envify&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>envify</span><span class=p>);</span> <span class=c1>// [Module: null prototype] { default: [Function (anonymous)] }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>import</span><span class=p>(</span><span class=s2>&#34;loose-envify&#34;</span><span class=p>).</span><span class=nx>then</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span> <span class=c1>// [Module: null prototype] { default: [Function (anonymous)] }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span></code></pre></div><p><code>loose-envify</code>가 어떤 패키지인지는 차치하고, 아무튼 import하더라도 정상적으로 resolve되어 내용물을 확인할 수 있다.</p><p>반면 Yarn PnP에서 설치된 경우 위 코드는 에러를 발생시킨다.</p><p><code>.yarn/cache</code> 디렉토리에는 분명 <code>loose-envify-npm-1.4.0-6307b…..zip</code> 파일이 존재한다. 근데 어째서 resolve되지 않는 것일까? 이는 <strong>Yarn PnP에서는 외부 모듈을 <code>.yarn/cache</code>가 아닌, <code>/.pnp.cjs</code> 파일로부터 가져오기 때문</strong>이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// .pnp.cjs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>$$SETUP_STATE</span><span class=p>(</span><span class=nx>hydrateRuntimeState</span><span class=p>,</span> <span class=nx>basePath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>hydrateRuntimeState</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=err>&#39;</span><span class=p>{</span><span class=o>\</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>[</span><span class=s2>&#34;react-dom&#34;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;npm:18.2.0&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageLocation&#34;</span><span class=o>:</span> <span class=s2>&#34;./.yarn/cache/react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip/node_modules/react-dom/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageDependencies&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s2>&#34;react-dom&#34;</span><span class=p>,</span> <span class=s2>&#34;npm:18.2.0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;linkType&#34;</span><span class=o>:</span> <span class=s2>&#34;SOFT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=s2>&#34;virtual:34069774f764f6c076c76cefb79f9c00ee35c2ecc2faeec6f1f046eac9e499da19f7441a38c80f3dc82287abf91ba64b7783b2e2d997751e40d1ad563ff4f78d#npm:18.2.0&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;packageLocation&#34;</span><span class=o>:</span> <span class=s2>&#34;./.yarn/__virtual__/react-dom-virtual-67ee33d872/0/cache/react-dom-npm-18.2.0-dd675bca1c-7d323310be.zip/node_modules/react-dom/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span></code></pre></div><p>앞에서 첨부했던 <code>.pnp.cjs</code> 파일의 일부다. 이 파일은 <code>package.json</code>을 기반으로 의존성 트리를 구성하여 갖고 있고, 물론 <code>react-dom</code> 패키지가 사용하는 <code>loose-envify</code> 역시 포함하고 있다. 하지만 프로젝트에 명시된 의존성(<code>react-dom</code>)은 다른 패키지들과 달리 <code>virtual:…</code>로 시작하는 가상 경로가 부여되어 있다. 이 가상 경로가 부여되지 않은 패키지는 resolve될 수 없다.</p><p>정확한 명칭은 <strong>가상 로케이터</strong>라고 부르는데, 자세한 내용은 <a href=https://yarnpkg.com/advanced/pnp-spec>Yarn의 PnP Specification</a> 페이지에서 알 수 있다.</p><p>이 과정을 통해 개인적인 이해를 위해 유추한 내용을 정리하자면,</p><ol><li><code>package.json</code>을 기반으로 <code>.pnp.cjs</code>에서 의존성 트리를 구성한다.</li><li>코드가 실행되면 Yarn PnP는 이를 통해 가상 <code>node_modules</code> 폴더를 구성한다.</li><li><code>react-dom</code>을 부여된 가상 경로에 존재하는 것처럼 연결한다.</li><li>해당 가상 경로에 <code>react-dom</code>이 참조하는 의존성 패키지들을 또 연결한다(<code>node_modules</code>처럼)</li><li><code>loose-envify</code>의 경우 <code>react-dom</code>의 하위 디렉토리에 있는 셈이니 가상 경로를 따로 부여할 필요가 없다,</li></ol><p>이렇게 <code>loose-envify</code>는 최상위 디렉토리로 hoist되지 않아 유령 의존성 문제도 발생하지 않고, 여러 번 참조될 경우 필요한 패키지들의 가상 경로에 같이 참조시키면 되므로 같은 파일을 여러 개 가질 필요도 없어진다. 최대한 이해하기 쉬우면서 틀리지 않도록 정리하려 노력했는데 제발 크게 틀린 부분이 없길 빈다.</p><h3 id=peer-dependency-문제>Peer dependency 문제</h3><aside><p>💡 <strong>아래 문제는 일반적이지 않습니다!</strong><br>재현할 수 있는 npm 패키지를 찾으려고 했지만, 대부분의 경우 peer dependency로만 명시된 의존성 패키지가 존재하지 않아 일반적인 문제가 아닙니다. 참고하세요~</p></aside><p><strong>Peer dependency</strong>란, 패키지가 다른 패키지와 상호작용함을 명시하는 종속성 필드다. 예를 들어 React 기반의 디자인 시스템은 React의 기능을 활용하지만, 패키지 자체에서 React를 포함할 필요는 없다. 이 경우 디자인 시스템에서 React를 Peer dependency로 지정하여 React의 어떤 버전이 필요함을 명시할 수 있는 것이다.</p><p>npm은 패키지를 설치할 때 peer dependency로 명시된 패키지를 같이 설치하려고 시도한다. 여태 꽤 많은 변화가 있었지만, 아무튼 npm 7.0 이후로는 설치하는 쪽으로 가닥을 잡은 모양이다. <a href=https://github.blog/2021-02-02-npm-7-is-now-generally-available/#peer-dependencies>[참고 링크]</a></p><p>반면에 Yarn PnP에서는 peer deps를 자동으로 설치하지 않는다. 예를 들어, <code>react</code>를 peer deps로 가진 <code>@chwh/cds</code> 패키지를 npm과 Yarn PnP에서 각각 설치하면 npm에는 <code>react</code>가 함께 설치되는 반면, Yarn PnP에서는 <code>cds</code>와 <code>cds</code>의 dependency의 일반 의존성 패키지(<code>lodash</code>)만이 설치된다.</p><p>단, <code>yarn install</code>을 했을 때 패키지가 요구하는 peer deps가 설치되지 않은 경우 아래와 같이 경고 메시지가 표시되며, 개발자는 이를 수동으로 설치함으로써 개발자가 직접 의존성에 대한 관리를 하도록 유도한다. 또 이러한 방식은 여러 패키지를 설치할 때의 의존성 그래프가 복잡해지는 현상을 방지한다고 한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>yarn</span>
</span></span><span class=line><span class=cl><span class=err>➤</span> <span class=n>YN0002</span><span class=err>:</span> <span class=err>│</span> <span class=n>berry</span><span class=nv>@workspace</span><span class=err>:</span><span class=p>.</span> <span class=n>doesn</span><span class=s1>&#39;t provide @emotion/react (p0d53b), requested by @chwh/cds
</span></span></span><span class=line><span class=cl><span class=s1>➤ YN0002: │ berry@workspace:. doesn&#39;</span><span class=n>t</span> <span class=n>provide</span> <span class=nv>@emotion</span><span class=p>/</span><span class=n>styled</span> <span class=p>(</span><span class=n>pe7b02</span><span class=p>),</span> <span class=n>requested</span> <span class=n>by</span> <span class=nv>@chwh</span><span class=p>/</span><span class=n>cds</span>
</span></span></code></pre></div><p>물론 예시로 든 <code>cds</code>를 사용하려면 리액트를 사용해야 하지만, 만약 peer dependency에만 명시된 패키지를 의존하면서 독립적으로 실행할 수 있을 것 <strong><em>처럼</em></strong> 보이는 패키지를 사용한다면, 수동으로 설치하지 않고서는 오류가 발생하게 될 것이다. 다만, 대부분의 경우 dependency로 명시된 패키지들 중에 peer dependency로 가지고 있는 패키지를 dependency로 갖는 식으로 의존성 트리가 채워지는 경우가 많기 때문에 자주 만나는 상황은 아니다.</p><h2 id=부록>부록</h2><h3 id=부록1---yarn-dlx와-pnpify>부록1 - yarn dlx와 pnpify</h3><p>Yarn PnP 환경에서 <code>npx</code>와 같은 명령어를 사용해야 할 때가 있고, 이에 대응하는 명령어가 <code>yarn dlx</code>이다. 예를 들어 <code>yarn dlx storybook init</code>을 실행하면 <code>npx storybook init</code>을 실행한 것과 같은 결과를, Yarn의 환경에 맞게 만들어 준다. <code>npx</code> 자체가 yarn과 npm 중 알맞은 패키지 매니저로 연결해 주지만, Yarn PnP는 그 외에도 추가적인 작업을 필요로 하기 때문에 제대로 작동하지 않기도 한다. Storybook에 Yarn PnP를 적용할 때가 대표적인 예시인데.. <a href=https://prayinforrain.github.io/posts/2023/04/nextjs-storybook-with-pnp/#%EB%82%B4%EA%B0%80-%EC%9D%B4%EA%B2%BC%EB%8B%A4-%EC%8A%A4%ED%86%A0%EB%A6%AC%EB%B6%81%EC%95%84>이 내용도 아주아주 간단하게 언급한 적이 있다.</a></p><p>반면 Yarn에는 pnpify라는 패키지가 존재한다. 보통 <code>package.json</code>에 정의되는 명령어들은(tsc나 vite build같은..) 여전이 로컬 파일 기반으로 패키지를 resolve하려 시도하는데, 압축된 패키지들을 사용하는 PnP 환경에서 제대로 작동하지 않는다. 이 문제를 해결하기 위해 위에 나온 방식으로 <strong>패키지를 resolve하는 로직을 교체해 주는 것</strong>이 <code>pnpify</code>이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// original
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s2>&#34;build&#34;</span><span class=o>:</span> <span class=s2>&#34;tsc -p tsconfig.publish.json &amp;&amp; vite build --config vite.publish.config.ts&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>// with pnp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s2>&#34;build&#34;</span><span class=o>:</span> <span class=s2>&#34;yarn pnpify tsc -p tsconfig.publish.json &amp;&amp; yarn pnpify vite build --config vite.publish.config.ts&#34;</span>
</span></span></code></pre></div><p><code>dlx</code>와 <code>pnpify</code>는 둘 다 PnP 환경에 맞도록 스크립트를 실행한다는 공통점이 있다. 다만 <code>dlx</code>는 프로젝트에 명시되지 않은 패키지를 일회성으로 다운로드하여 실행하고, <code>pnpify</code>는 PnP 환경에 맞게 기존 스크립트를 변환하여 실행한다는 차이점이 있으므로 상황에 맞도록 사용하면 되겠다. 예를 들어 프로젝트 초기화를 <code>dlx</code>로 한다던가..</p><h3 id=부록2---사실-모든-것이-pnp의-잘못은-아닙니다>부록2 - 사실 모든 것이 PnP의 잘못은 아닙니다</h3><p><code>Yarn berry</code>에서의 storybook 세팅에서, 특정 패키지가 resolve되지 않는 문제가 있었다. 앞에서 링크한 블로그 글에서 이 것이 Yarn PnP의 resolve 기준의 잘못인 것처럼 썼는데, 사실 이게 유일한 이유는 아니었다.</p><p>cds는 <code>@storybook/builder-vite</code> 패키지의 0.4.2 버전을 사용하고 있었는데, 의존성 설치를 마치고 스토리북을 실행해 보면 아래와 같은 오류를 뱉었다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>오후</span> <span class=mf>10</span><span class=err>:</span><span class=mf>13</span><span class=err>:</span><span class=mf>52</span> <span class=p>[</span><span class=no>vite</span><span class=p>]</span> <span class=n>Internal</span> <span class=n>server</span> <span class=n>error</span><span class=err>:</span> <span class=n>Failed</span> <span class=n>to</span> <span class=n>resolve</span> <span class=n>import</span> <span class=s2>&#34;@storybook/preview-web&#34;</span> <span class=n>from</span> <span class=s2>&#34;..\..\virtual:\@storybook\builder-vite\vite-app.js&#34;</span><span class=p>.</span> <span class=n>Does</span> <span class=n>the</span> <span class=n>file</span> <span class=n>exist</span><span class=p>?</span>
</span></span><span class=line><span class=cl>  <span class=n>Plugin</span><span class=err>:</span> <span class=n>vite</span><span class=err>:</span><span class=nb>import-analysis</span>
</span></span><span class=line><span class=cl>  <span class=n>File</span><span class=err>:</span> <span class=p>/</span><span class=n>virtual</span><span class=err>:</span><span class=p>/</span><span class=nv>@storybook</span><span class=p>/</span><span class=nb>builder-vite</span><span class=p>/</span><span class=nb>vite-app</span><span class=p>.</span><span class=n>js</span><span class=err>:</span><span class=mf>1</span><span class=err>:</span><span class=mf>45</span>
</span></span><span class=line><span class=cl>  <span class=mf>1</span>  <span class=p>|</span>  <span class=n>import</span> <span class=p>{</span> <span class=n>composeConfigs</span><span class=p>,</span> <span class=n>PreviewWeb</span> <span class=p>}</span> <span class=n>from</span> <span class=s1>&#39;@storybook/preview-web&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=p>|</span>                                              <span class=p>^</span>
</span></span><span class=line><span class=cl>  <span class=mf>2</span>  <span class=p>|</span>      <span class=n>import</span> <span class=p>{</span> <span class=n>ClientApi</span> <span class=p>}</span> <span class=n>from</span> <span class=s1>&#39;@storybook/client-api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=mf>3</span>  <span class=p>|</span>      <span class=n>import</span> <span class=s1>&#39;/virtual:/@storybook/builder-vite/setup-addons.js&#39;</span><span class=p>;</span>
</span></span></code></pre></div><p>따라서 <code>@storybook/preview-web</code>이라는 패키지를 추가로 설치해 주어야 했고, 그 외에도 몇몇 의존성을 추가로 설치해야만 했다. 그런데.. <code>@storybook/preview-web</code>은 <code>@storybook/builder-vite</code>의 dependency에 들어가 있지 않았다.</p><p>그럼에도 이 패키지가 <code>@storybook/preview-web</code>를 요구할 수 있었던 이유는..</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=c1>// @storybook/builder-vite/dist/optimizeDeps.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>INCLUDE_CANDIDATES</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=s2>&#34;@storybook/preview-web&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>];</span>
</span></span></code></pre></div><p><code>optimizeDeps.js</code>라는 파일에서 필요로 하는 외부 모듈들을 따로 적어 두고 있기 때문이었다. 아마 이 파일은 <code>vite</code>의 <a href=https://vitejs-kr.github.io/config/dep-optimization-options.html>디펜던시 최적화 옵션</a>을 설정하는 파일로 보인다.</p><p>스토리북은 리액트를 CRA를 통해 초기 설정을 하듯이 통상 <code>npx storybook init</code>을 통해 초기 설정을 진행하기 때문에 <code>package.json</code>에 의존성이 제대로 명시되어 있지 않은 듯 하다. 어찌 보면 유령 의존성 현상을 이용하는 셈이다.</p><p>이게 <code>@storybook/builder-vite@0.4.2</code> 버전의 코드인데, Storybook 7의 릴리즈 이후로 builder 플러그인들이 스토리북 메인 레포지토리에 모노레포 형태로 통합되던 시기 근처로 의존성 역시 제대로 명시되었다. <a href=https://github.com/storybookjs/storybook/commit/f80ef5f40ab5ecaf29e83f1435809de4c724d2fc>[관련 커밋]</a> 따라서 <strong>지금은 해당되지 않는 이슈</strong>이며, 빌더의 버전 역시 다른 addon과 마찬가지로 스토리북의 버전과 통일되었다.</p><h2 id=마치며>마치며..</h2><p><img src=/images/posts/2023/05/exploring-yarn-berry/03.png alt="cds issue"></p><p>사실 조금 뜬금없이 준비한 발표 자료인데, 가볍게만 해야지.. 하고 시작했다가 어렴풋이 예상했던 내용이 틀리고 틀리고를 반복해서 검증을 반복하다가 글이 태산으로 가버렸다. 마지막에는 내가 왜 이걸 보고 있었는지를 까먹어서 손을 놓고 다시 컨텍스트를 따라가기도 했다. 그러니까 음.. 매끄러운 글은 아닌 것 같다. 내용 없이 주제만 정하고 시작한 글이라 그런가..</p><p>이 글을 끝으로 더 이상 얀베리를 붙들고 씨름하는 일은 없었으면 좋겠지만 아마 그렇진 못할 것 같고.. 다음 프로젝트를 한다면 반드시 pnpm을 써 보고 싶다는 생각을 하고 있다. CDS를 하면서 pnpm을 사용하는 레퍼런스가 꽤 많다는 것을 알았고, Yarn에서도 <a href=https://github.com/yarnpkg/berry/pull/3338>pnpm 링커를 지원</a>하고 있으니 pnpm도 그만의 장점이 있겠구나 하는 막연한 생각 중.</p><h2 id=refs>Refs.</h2><p><a href=https://github.com/yarnpkg/berry>GitHub - yarnpkg/berry: 📦🐈 Active development trunk for Yarn ⚒</a><br><a href=https://yarnpkg.com/features/pnp>Plug&rsquo;n&rsquo;Play</a><br><a href=https://velog.io/@superlipbalm/everything-you-need-to-know-about-javascript-import-maps>(번역) 자바스크립트 Import Map에 대해 알아야 할 모든 것</a><br><a href=https://yceffort.kr/2021/10/debt-of-package-json>package.json에 쌓여있는 개발 부채</a><br><a href=https://toss.tech/article/node-modules-and-yarn-berry>node_modules로부터 우리를 구원해 줄 Yarn Berry</a><br><a href=https://github.blog/2021-02-02-npm-7-is-now-generally-available/#peer-dependencies>npm 7 is now generally available!</a><br><a href=https://prayinforrain.github.io/posts/2023/04/nextjs-storybook-with-pnp>Next.js Storybook에 Yarn PnP 적용하기 | PrayinForRain.dev</a><br><a href=https://vitejs-kr.github.io/config/dep-optimization-options.html>Vite</a><br><a href=https://woong-jae.com/projects/220711-pnp-dependency-error>Yarn PnP 의존성 에러 해결기</a><br><a href=https://github.com/nodejs/node>GitHub - nodejs/node: Node.js JavaScript runtime</a><br><a href=https://nodejs.org/api/esm.html#resolver-algorithm-specification>Modules: ECMAScript modules | Node.js v20.2.0 Documentation</a></p></div></article><article id=giscus-wrapper></article><script>const giscus_light="https://cdn.jsdelivr.net/gh/prayinforrain/prayinforrain.github.io@main/static/styles/_giscus.css",giscus_dark="https://cdn.jsdelivr.net/gh/prayinforrain/prayinforrain.github.io@main/static/styles/_giscus_dark.css";let giscusTheme=localStorage.getItem("theme");giscusTheme||(giscusTheme="light",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(defaultTheme="dark"));let giscusAttributes={src:"https://giscus.app/client.js","data-repo":"prayinforrain/prayinforrain.github.io","data-repo-id":"R_kgDOItUJmA","data-category":"Announcements","data-category-id":"DIC_kwDOItUJmM4CTXa0","data-mapping":"pathname","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme==="dark"?giscus_dark:giscus_light,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t)),document.getElementById("giscus-wrapper").appendChild(giscusScript)</script></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/prayinforrain target=_blank rel="noopener noreferrer me" title=Github><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=mailto:prayinforrain@naver.com target=_blank rel="noopener noreferrer me" title=Email><svg viewBox="0 0 24 21" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2024 PrayinforRain.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel="noreferrer noopener">Hugo blog awesome</a>
theme on
<a href=https://gohugo.io target=_blank rel="noreferrer noopener">Hugo</a>.</small></footer><a href=# title="Go to top" id=totop><svg width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg>
</a><script src=https://prayinforrain.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script><script src=https://prayinforrain.github.io/js/custom.min.d9a0ea0a65c1b01e922173e72cd81eedad8ae4b3ca9396e95f24b6e7d29a94c8.js integrity="sha256-2aDqCmXBsB6SIXPnLNge7a2K5LPKk5bpXyS259KalMg="></script></body></html>